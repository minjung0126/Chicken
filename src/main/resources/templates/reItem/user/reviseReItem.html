<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>

    <title>chicken stock</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/common/common.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/returnItem/storeReItem.css}"/>
    <!-- datepicker js & css -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- table css -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/common/style.css}"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        #layerPop {
            display:none;
            border:1px solid #ccc;
            padding:10px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgb(0 0 0 / 20%);
            border-radius: 10px;
        }

        #layerPop .close {
            position:absolute;
            bottom:5px;
            right:5px;
        }
        .close-btn {
            position: absolute;
            right: 10px;
            top: 47px;
        }

    </style>
</head>
<body>
<div class="wrap">

    <!-- S: header -->
    <div th:include="common/userHeader.html"></div>
    <!-- S: header -->

    <!-- S: container -->
    <div class="container px-0">

        <!-- sidebar -->
        <div th:replace="common/userSidebar.html"></div>

        <!-- S: main layout -->
        <div class="main_layout">
            <div class="main_layout_inner">

                <!-- 작업 영역 -->
                <!-- S: table -->
                <div class="container-fluid" style="margin-top:30px">
                    <h3><i class="fa-solid fa-list-check"></i> 반품 내역</h3>
                    <br>
                    <div class="input-group mb-4 col-12">
                        <div class="dateList1"> 반품 신청일 :
                            <span id="dueDate" th:text="${ updateItem.rDate }"></span>
                        </div>
                        <div class="dateList2" style="font-weight: bold;">
                            <select id="rReason" name="rReason" class="form-control col-4" style="max-width: max-content; margin-right: 10px; display: inline-block; border: none;">
                                <option value="date"> - 반품사유 - </option>
                                <option value="date1">실수로 잘못 주문함</option>
                                <option value="date2">배송중 손상됨</option>
                                <option value="date3">더이상 필요하지 않음</option>
                                <option value="date4">유통기한이 지난(짧은) 상품 배송</option>
                            </select>
                        </div>
                        <div class="dateList3" style="font-weight: bold;">
                            총 반품액 :
                            <input type="text" id="returnTotalMoney" class="returnTotalMoney" th:value="|${ #numbers.formatInteger(updateItem.returnTotalMoney, 0, 'COMMA') }원|" style="width: 150px; background-color: #f5f5f9" readonly>
                            <input type="hidden" name="returnTotalMoney" id="reTotal">
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-warning mx-1" style="color: #fff;" onclick="openLayer('layerPop',7, 12)">품목 추가</button>
                        <div id="layerPop" class="p-5" style="display:none; width: 75%; height: 800px; position: absolute; z-index: 1; overflow: scroll;">
                            <div class="mt-3 d-flex justify-content-end">
                                <input type="hidden" name="itemNoList" id="result">
                                <button class="btn btn-warning me-1" type="button" style="color: #fff;" onclick='getCheckboxValue()'>품목 추가</button>
                            </div>
                            <table class="table"  style="margin-top: -8px;">
                                <thead>
                                <tr>
                                    <th>상품코드</th>
                                    <th>썸네일</th>
                                    <th>상품명</th>
                                    <th>카테고리</th>
                                    <th>규격</th>
                                    <th>제조사(원산지)</th>
                                    <th>매출단가</th>
                                    <th>재고량</th>
                                    <th>반품수량</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each=" st : ${ storeItems }">
                                    <td th:text="${ st.itemNo }"></td>
                                    <td>
                                        <div class="img-info">
                                            <div class="img-info__img">
                                                <img th:src="'/itemImage/' + ${ st.fileName }" alt="">
                                            </div>
                                        </div>
                                    </td>
                                    <td th:text="${ st.itemName }"></td>
                                    <td th:text="${ st.categoryName }"></td>
                                    <td th:text="${ st.itemStandard }"></td>
                                    <td th:text="${ st.itemMake }"></td>
                                    <td th:text="|${ #numbers.formatInteger(st.itemSales, 0, 'COMMA') }원|"></td>
                                    <td th:text="${ st.storeAmount }"></td>
                                    <td >
                                        <input type="number" min="0" th:max="${ st.storeAmount }" style="width:60px; text-align: center; border: 1px solid rgb(255, 255, 255); border-bottom: 1px solid;" >
                                        <button type="submit" style="border : none; background-color: #fff;"></button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <div class="close-btn">
                                <a href="#" onclick="closeLayer('layerPop')" class="close">
                                    <i class="fa fa-times close" onclick="closeLayer('layerPop')"></i>
                                </a>
                            </div>
                        </div>
                        <button class="btn btn-warning mx-1" onclick="correctionForm()" style="color: #fff;">수정</button>
                        <button class="btn btn-warning mx-1" onclick="location.href='storeReList.html'" style="color: #fff;">돌아가기</button>
                    </div>
                    <table class="table">
                        <thead>
                        <tr>
                            <th>
                                <div class="form-check pb-3">
                                    <input type="checkbox" class="form-check-input" id="cbx_chkAll2" required/>
                                </div>
                            </th>
                            <th>상품코드</th>
                            <th>썸네일</th>
                            <th>상품명</th>
                            <th>카테고리</th>
                            <th>규격</th>
                            <th>제조사(원산지)</th>
                            <th>판매가격</th>
                            <th>반품수량</th>
                            <th>삭제</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each=" reUp : ${ updateItems }">
                            <td>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="chk2">
                                    <label class="form-check-label"></label>
                                </div>
                            </td>
                            <td th:text="${ reUp.itemNo }"></td>
                            <input type="hidden" name="itemNo2" th:value="${ reUp.itemNo }">
                            <td>
                                <div class="img-info">
                                    <div class="img-info__img">
                                        <img th:src="'/itemImage/' + ${ reUp.fileName }" alt="">
                                    </div>
                                </div>
                            </td>
                            <td th:text="${ reUp.itemName }"></td>
                            <td th:text="${ reUp.categoryName }"></td>
                            <td th:text="${ reUp.itemStandard }"></td>
                            <td th:text="${ reUp.itemMake }"></td>
                            <td id="itemPurchase" class="itemPurchase" th:text="|${ #numbers.formatInteger(reUp.itemSales, 0, 'COMMA') }원|"></td>
                            <td>
                                <input type="number" min="0" th:max="${ reUp.storeAmount }" style="width:60px; text-align: center; border: 1px solid rgb(255, 255, 255); border-bottom: 1px solid;" th:value="${ reUp.returnCount }" class="returnAmount" id="returnCount" onchange="inputValueChange(this);">
                                <input type="hidden" name="returnCount2">
                                <button type="submit" style="border : none; background-color: #fff;"></button>
                            </td>
                            <td><button class="btn btn-warning me-1" type="button" style="color: #fff;">삭제</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <!-- E: table -->

            </div>
        </div>
        <!-- E: main layout -->
    </div>
    <!-- E: container -->
</div>
<!-- table js -->
<!-- 반품신청 -->
<script type="text/javascript">
    function correctionForm() {
        var result = confirm("수정완료 하시겠습니까?");
        if(result == true) {
            alert("신청서 수정이 완료되었습니다.");
        }
    }

    let select = $("#rReason option");
    $(select).prop("selected", true);

    let returnTotalMoney = [[${ updateItem.returnTotalMoney }]];

    function inputValueChange(check){

        // 반품수량
        let inputValue = $(check.parentElement)[0].children[0].value;
        console.log(inputValue);

        // 입고금액
        let itemPurchase = parseInt(check.parentElement.parentElement.children[8].innerText.replace(/[^0-9]/gi, ''));
        let returnItemMoney = inputValue * itemPurchase;

        console.log(itemPurchase);
        console.log(returnItemMoney);

        returnTotalMoney += returnItemMoney;
        console.log(returnTotalMoney);
        document.getElementById('returnTotalMoney').value = returnTotalMoney.toLocaleString('ko-KR') + "원";
        document.getElementById('reTotal').value = returnTotalMoney;

        $(check.parentElement)[0].children[1].value = inputValue;

    }


    $(".detail-main").click(function() {
        $(this).next(".detail-sub-tr").find(".detail-sub").slideToggle(300);
        $(this).toggleClass('on').siblings().removeClass('on');
        $(this).next(".detail-sub-tr").find(".detail-sub").siblings(".detail-sub").slideUp(300);
    });

    function openLayer(IdName, tpos, lpos){
        var pop = document.getElementById(IdName);
        pop.style.display = "block";
        pop.style.top = tpos + "%";
        pop.style.left = lpos + "%";
    }
    function closeLayer(IdName){
        var pop = document.getElementById(IdName);
        pop.style.display = "none";
    }

</script>
<!-- 체크박스 선택 스크립트 -->
<script type="text/javascript">
    $(document).ready(function() {
        $("#cbx_chkAll2").click(function() {
            if($("#cbx_chkAll2").is(":checked")) $("input[name=chk2]").prop("checked", true);
            else $("input[name=chk2]").prop("checked", false);
        });

        $("input[name=chk2]").click(function() {
            var total = $("input[name=chk2]").length;
            var checked = $("input[name=chk2]:checked").length;

            if(total != checked) $("#cbx_chkAll2").prop("checked", false);
            else $("#cbx_chkAll2").prop("checked", true);
        });
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>