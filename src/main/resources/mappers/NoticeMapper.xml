<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chicken.project.notice.model.dao.NoticeMapper">
    <resultMap id="noticeResultMap" type="NoticeDTO">
        <id property="noticeNo" column="NOTICE_NO"/>
        <result property="noticeName" column="NOTICE_NAME"/>
        <result property="noticeContent" column="NOTICE_CONTENT"/>
        <result property="noticeRegistDate" column="NOTICE_REGIST_DATE"/>
        <result property="noticeModifyDate" column="NOTICE_MODIFY_DATE"/>
        <result property="empId" column="EMP_ID"/>

        <collection property="noticeFile" ofType="NoticeFileDTO">
            <result property="originName" column="ORIGIN_NAME"/>
        </collection>
    </resultMap>

    <resultMap id="noticeFileResultMap" type="NoticeFileDTO">
        <id property="fileNo" column="FILE_NO"></id>
        <result property="originName" column="ORIGIN_NAME"></result>
        <result property="fileName" column="FILE_NAME"></result>
        <result property="noticeNo" column="NOTICE_NO"></result>
    </resultMap>

    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
               COUNT(*)
          FROM NOTICE A
      <if test="searchCondition == 'writer'">
          JOIN EMPLOYEE B ON(A.EMP_ID = B.EMP_ID)
      </if>
        <where>
            <if test="searchCondition == 'writer'">
                B.EMP_ID LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'title'">
                A.NOTICE_NAME LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'content'">
                A.NOTICE_CONTENT LIKE '%' || #{ searchValue } || '%'
            </if>
        </where>
     ORDER BY A.NOTICE_NO DESC
    </select>

    <select id="selectNoticeList" resultMap="noticeResultMap">
        SELECT
               A.RNUM
             , A.NOTICE_NO
             , A.NOTICE_NAME
             , A.EMP_ID
             , A.NOTICE_CONTENT
             , A.NOTICE_REGIST_DATE
             , D.EMP_ID
          FROM (SELECT ROWNUM RNUM
                     , B.NOTICE_NO
                     , B.NOTICE_NAME
                     , B.EMP_ID
                     , B.NOTICE_CONTENT
                     , B.NOTICE_REGIST_DATE
                  FROM (SELECT C.NOTICE_NO
                             , C.NOTICE_NAME
                             , C.EMP_ID
                             , C.NOTICE_CONTENT
                             , C.NOTICE_REGIST_DATE
                          FROM NOTICE C
        <if test="searchCondition == 'writer'">
            JOIN EMPLOYEE D ON(C.EMP_ID = D.EMP_ID)
        </if>
        <where>
            <if test="searchCondition == 'writer'">
                D.EMP_ID LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'title'">
                C.NOTICE_NAME LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'content'">
                C.NOTICE_CONTENT LIKE '%' || #{ searchValue } || '%'
            </if>
        </where>
        ORDER BY C.NOTICE_NO DESC
        ) B
        <![CDATA[
                  WHERE ROWNUM <= #{ endRow }
                  ]]>
        ) A
        JOIN EMPLOYEE D ON (A.EMP_ID = D.EMP_ID)
        WHERE A.RNUM >= #{ startRow }
        ORDER BY 1 ASC
    </select>

    <insert id="noticeInsert">
        INSERT
          INTO NOTICE
        (
          NOTICE_NO
        , NOTICE_NAME
        , NOTICE_CONTENT
        , NOTICE_REGIST_DATE
        , NOTICE_MODIFY_DATE
        , EMP_ID
        )
        VALUES
        (
          SEQ_NOTICE_NO.NEXTVAL
        , #{ noticeName }
        , #{ noticeContent }
        , SYSDATE
        , NULL
        , 'test01'
        )
    </insert>

    <insert id="noticeFileInsert">
        <selectKey keyProperty="noticeNo" order="BEFORE" resultType="_int">
            SELECT
                   SEQ_NOTICE_NO.CURRVAL
              FROM DUAL
        </selectKey>
        INSERT
          INTO NOTICE_FILE
        (
          FILE_NO
        , ORIGIN_NAME
        , FILE_NAME
        , NOTICE_NO
        )
        VALUES
        (
          SEQ_NOTICE_FILE_NO.NEXTVAL
        , #{ originName }
        , #{ fileName }
        , #{ noticeNo }
        )
    </insert>

    <select id="noticeDetailByNo" resultMap="noticeResultMap">
        SELECT
               A.*
             , B.*
          FROM NOTICE A
          JOIN NOTICE_FILE B ON (A.NOTICE_NO = B.NOTICE_NO)
         WHERE A.NOTICE_NO = #{ noticeNo }
    </select>

    <delete id="deleteNotice" parameterType="NoticeDTO">
        DELETE
          FROM NOTICE
         WHERE NOTICE_NO = #{ noticeNo }
    </delete>

    <delete id="deleteNoticeFile" parameterType="NoticeFileDTO">
        DELETE
          FROM NOTICE_FILE
         WHERE NOTICE_NO = #{ noticeNo }
    </delete>
</mapper>
